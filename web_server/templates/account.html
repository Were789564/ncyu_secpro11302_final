<!DOCTYPE html>
<html>
<head>
    <title>å¸³è™Ÿè¨­å®š - SecureWeb</title>
</head>
<body>
    {% extends "base.html" %}

    {% block title %}å¸³è™Ÿè¨­å®š - SecureWeb{% endblock %}

    {% block content %}
    <div class="card">
        <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">âš™ï¸ å¸³è™Ÿè¨­å®š</h2>
        
        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}
        
        {% if success %}
            <div class="success">{{ success }}</div>
        {% endif %}
        
        <!-- CSRF ä¿è­·èªªæ˜ -->
        <div style="background: #e3f2fd; padding: 1rem; border-radius: 10px; margin-bottom: 2rem;">
            <h4 style="color: #1976d2; margin-bottom: 0.5rem;">ğŸ”’ CSRF ä¿è­·æ©Ÿåˆ¶</h4>
            <p style="color: #333; font-size: 0.9rem;">
                æ­¤è¡¨å–®å—åˆ° CSRF (Cross-Site Request Forgery) ä¿è­·ã€‚æ¯æ¬¡æäº¤éƒ½éœ€è¦æœ‰æ•ˆçš„ CSRF tokenã€‚
            </p>
            <p style="color: #666; font-size: 0.8rem;">
                ç•¶å‰ CSRF Token: <code style="background: #f5f5f5; padding: 2px 4px;">{{ csrf_token[:8] }}...</code>
            </p>
        </div>
        
        <form method="POST">
            <!-- éš±è—çš„ CSRF token -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="form-group">
                <label for="current_username">ç›®å‰ç”¨æˆ¶å</label>
                <input type="text" id="current_username" value="{{ user.username }}" disabled 
                       style="background: #f5f5f5; color: #666;">
                <small style="color: #666;">ç”¨æˆ¶åç„¡æ³•ä¿®æ”¹</small>
            </div>
            
            <div class="form-group">
                <label for="email">é›»å­éƒµä»¶</label>
                <input type="email" id="email" name="email" value="{{ user.email or '' }}" 
                       placeholder="è¼¸å…¥æ–°çš„é›»å­éƒµä»¶åœ°å€">
            </div>
            
            <div class="form-group">
                <label for="new_password">æ–°å¯†ç¢¼</label>
                <input type="password" id="new_password" name="new_password" 
                       placeholder="è¼¸å…¥æ–°å¯†ç¢¼ (ç•™ç©ºå‰‡ä¸ä¿®æ”¹)">
                <small style="color: #666;">å¯†ç¢¼ä¿®æ”¹å¾Œéœ€è¦é‡æ–°ç™»å…¥</small>
            </div>
            
            <button type="submit" class="btn">ğŸ’¾ æ›´æ–°è³‡æ–™</button>
        </form>
        
        <!-- CSRF æ”»æ“Šæ¸¬è©¦å€åŸŸ -->
        <div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
            <h4 style="color: #856404; margin-bottom: 0.5rem;">ğŸ§ª CSRF æ”»æ“Šæ¸¬è©¦</h4>
            <p style="color: #856404; font-size: 0.9rem;">
                ä»¥ä¸‹æ˜¯æ¸¬è©¦ CSRF æ”»æ“Šçš„ç¯„ä¾‹ã€‚æ­£å¸¸æƒ…æ³ä¸‹ï¼Œæ²’æœ‰æ­£ç¢º CSRF token çš„è«‹æ±‚æœƒè¢«æ‹’çµ•ï¼š
            </p>
            
            <!-- æ²’æœ‰ CSRF token çš„æƒ¡æ„è¡¨å–® -->
            <form method="POST" style="margin-top: 1rem; padding: 1rem; background: #ffebee; border-radius: 5px;">
                <h5 style="color: #c62828;">âŒ æƒ¡æ„è¡¨å–® (æ²’æœ‰ CSRF token)</h5>
                <input type="hidden" name="new_password" value="hacked123">
                <input type="hidden" name="email" value="hacker@evil.com">
                <button type="submit" style="background: #c62828; font-size: 0.8rem; padding: 0.5rem 1rem;">
                    å˜—è©¦ CSRF æ”»æ“Š
                </button>
                <small style="display: block; color: #c62828; margin-top: 0.5rem;">
                    æ­¤æ”»æ“Šæ‡‰è©²æœƒå¤±æ•—ï¼Œå› ç‚ºæ²’æœ‰æœ‰æ•ˆçš„ CSRF token
                </small>
            </form>
        </div>
        
        <!-- ç®¡ç†å“¡å°ˆç”¨é€£çµ -->
        {% if user.username == 'admin' %}
        <div style="margin-top: 2rem; text-align: center;">
            <a href="/admin/users" style="color: #007bff; text-decoration: none; margin-right: 1rem;">[ç®¡ç†å“¡] æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶</a>
            <a href="/admin/comments" style="color: #007bff; text-decoration: none;">[ç®¡ç†å“¡] æŸ¥çœ‹æ‰€æœ‰ç•™è¨€</a>
        </div>
        {% endif %}
    </div>

    <script>
    // é¡¯ç¤ºç•¶å‰çš„ CSRF token (ç”¨æ–¼æ¼”ç¤º)
    console.log('Current CSRF Token:', '{{ csrf_token }}');
    
    // è¡¨å–®æäº¤æ™‚çš„æé†’
    document.querySelector('form').addEventListener('submit', function(e) {
        const password = document.getElementById('new_password').value;
        if (password && !confirm('ç¢ºå®šè¦ä¿®æ”¹å¯†ç¢¼å—ï¼Ÿä¿®æ”¹å¾Œéœ€è¦é‡æ–°ç™»å…¥ã€‚')) {
            e.preventDefault();
        }
    });
    </script>
    {% endblock %}
</body>
</html>
